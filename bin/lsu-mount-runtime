#!/usr/bin/env ruby
# encoding: UTF-8

require 'fileutils'
require_relative '.utils'

EMUL_PATH = File.realdirpath(`sysctl -qn compat.linux.emul_path`).chomp
SLR_DIR   = ARGV[0] || 'SteamLinuxRuntime_sniper'

if not EMUL_PATH =~ /\/compat\/\w[\w\d]*/
  STDERR.puts "This script doesn't like your compat.linux.emul_path."
  exit(1)
end

if not SLR_DIR =~ /SteamLinuxRuntime_\w+/
  STDERR.puts "Expected the directory name starting with SteamLinuxRuntime_."
  exit(1)
end

if `sysctl -nq vfs.usermount`.to_i != 1
  STDERR.puts "This script requires vfs.usermount=1."
  exit(1)
end

if not system('kldstat -q -m nullfs')
  STDERR.puts "nullfs.ko must be loaded."
  exit(1)
end

if not ENV['HOME']
  STDERR.puts "$HOME is undefined."
  exit(1)
end

steam_linux_runtime_path = find_steamapp_dir(SLR_DIR)
if not steam_linux_runtime_path
  STDERR.puts "Can't find #{SLR_DIR}."
  exit(1)
end

platform = Dir[File.join(steam_linux_runtime_path, "#{SLR_DIR.delete_prefix('SteamLinuxRuntime_')}_platform_*")].first
raise if not platform

mtree = Dir.chdir(platform) do
  `zcat usr-mtree.txt.gz`.lines.reject{|line| line.start_with?('#')}.map do |line|
    path, *attrs = line.split(' ')
    attrs = Hash[attrs.map{|a| a.split('=')}]
    [path, attrs]
  end
end

mroot = File.join(ENV['HOME'], '.steam/mnt', SLR_DIR)
FileUtils.mkdir_p(mroot)

$MOUNTS = []

def mount(fs, from, to, options = nil)
  if fs == 'nullfs' && File.file?(from)
    FileUtils.touch(to)
  else
    FileUtils.mkdir_p(to)
  end
  cmd = "mount #{if options then "-o #{options}" else '' end} -t #{fs} #{from} #{to}"
  STDERR.puts cmd
  if system(cmd)
    $MOUNTS << File.realpath(to)
  end
end

if system("mount -o nocover -t tmpfs tmpfs #{mroot}")
  $MOUNTS << mroot
  begin
    Dir.chdir(mroot) do

      FileUtils.mkdir_p('usr')

      Dir.chdir('usr') do
        #TODO: verify that path doesn't go outside of mroot
        mtree.each do |path, attrs|
          case attrs['type']
            when 'link'
              #~ if attrs['link'] == '../usr/lib/os-release'
                #~ FileUtils.ln_s('/usr/lib/os-release', path)
              #~ else
                FileUtils.ln_s(attrs['link'], path)
              #~ end
            when 'file'
              next if path == './bin/\\133' || path =~ /NetLock_Arany_/
              if attrs['size'] != '0'
                FileUtils.cp(File.join(platform, 'files', path), path)
              else
                FileUtils.touch(path)
              end
              #TODO: set mode?
            when 'dir'
              FileUtils.mkdir_p(path)
            else
              raise "Unknown attr #{attrs['type'].inspect}"
          end
        end

        # wtf with those incorrect symlinks?
        Dir.chdir('lib/x86_64-linux-gnu/dri') do
          FileUtils.ln_s('../../..', 'usr')
        end

        Dir.chdir('lib/i386-linux-gnu/dri') do
          FileUtils.ln_s('../../..', 'usr')
        end
      end # chdir('usr')

      #~ FileUtils.ln_s('/', 'usr') # ?

      FileUtils.ln_s('usr/bin',   'bin')
      FileUtils.ln_s('usr/lib',   'lib')
      FileUtils.ln_s('usr/lib64', 'lib64')

      FileUtils.mv('usr/etc', 'etc') #?
      FileUtils.rm('bin/zenity') #?

      mount('linprocfs', 'linprocfs', 'proc')
      mount('linsysfs',  'linsysfs',  'sys')
      mount('devfs',     'devfs',     'dev')

      # we can't mount anything over devfs from a non-root user,
      # let's abuse emul_path redirection instead
      mount('fdescfs', 'fdescfs',                       File.join('.', EMUL_PATH, 'dev/fd'), 'linrdlnk')
      mount('nullfs',  File.join(EMUL_PATH, 'dev/shm'), File.join('.', EMUL_PATH, 'dev/shm'))

      # placing $HOME under emul_path avoids some redirection issues
      # with Counter-Strike 2, Torchlight 2
      #TODO: there might be mount points under $HOME
      home_dir = File.realpath(ENV['HOME'])
      mount('nullfs', home_dir, File.join('.', home_dir))
      mount('nullfs', home_dir, File.join('.', EMUL_PATH, home_dir))

      if File.symlink?('/home') && File.readlink('/home') == 'usr/home'
        FileUtils.ln_s('usr/home', 'home')
        FileUtils.ln_s('usr/home', File.join('.', EMUL_PATH, 'home'))
      end

      # handy for diagnostics
      if File.exist?(File.join(EMUL_PATH, 'bin/glxgears'))
        FileUtils.cp(File.join(EMUL_PATH, 'bin/glxgears'), 'bin/glxgears')
      end

      # X11
      mount('nullfs', '/tmp', 'tmp')

      # Nvidia
      for source_dir, dest_dir in {
        File.join(EMUL_PATH, 'usr/lib64') => 'lib/x86_64-linux-gnu',
        File.join(EMUL_PATH, 'usr/lib')   => 'lib/i386-linux-gnu'
      }
        for path in Dir[File.join(source_dir, 'lib{nvidia-*.so*,GLX_nvidia*.so*}')]
          if File.symlink?(path)
            FileUtils.ln_s(File.readlink(path), File.join(dest_dir, File.basename(path)))
          else
            FileUtils.cp(path, dest_dir)
          end
        end
      end

      if File.exist?('/usr/local/share/vulkan/icd.d/nvidia_icd.json')
        FileUtils.cp('/usr/local/share/vulkan/icd.d/nvidia_icd.json', 'etc/vulkan/icd.d/')
      end

      # eON workaround
      for i in 0..64 do
        FileUtils.mkdir_p(File.join('.', EMUL_PATH, "sys/devices/system/cpu/cpu#{i}/topology/"))
        File.write(File.join('.', EMUL_PATH, "sys/devices/system/cpu/cpu#{i}/topology/core_id"), i.to_s)
      end

      # dns
      FileUtils.cp('/etc/resolv.conf', 'etc/')

      # dbus
      FileUtils.cp('/etc/machine-id', 'etc/')

      # getpwuid_r()
      FileUtils.cp('/etc/passwd', 'etc/')

      # sound
      FileUtils.cp(File.join(EMUL_PATH, 'etc/asound.conf'), 'etc/')
      FileUtils.cp(File.join(EMUL_PATH, 'usr/lib64/alsa-lib/libasound_module_ctl_oss.so'), 'usr/lib/x86_64-linux-gnu/alsa-lib/')
      FileUtils.cp(File.join(EMUL_PATH, 'usr/lib64/alsa-lib/libasound_module_pcm_oss.so'), 'usr/lib/x86_64-linux-gnu/alsa-lib/')
      FileUtils.cp(File.join(EMUL_PATH, 'usr/lib/alsa-lib/libasound_module_ctl_oss.so'),   'usr/lib/i386-linux-gnu/alsa-lib/')
      FileUtils.cp(File.join(EMUL_PATH, 'usr/lib/alsa-lib/libasound_module_pcm_oss.so'),   'usr/lib/i386-linux-gnu/alsa-lib/')
      mount('nullfs', File.join(EMUL_PATH, 'etc/alsa'), 'etc/alsa') #?
      mount('nullfs', File.join(EMUL_PATH, 'usr/share/alsa'), 'usr/share/alsa')

      # just in case
      lsu_dir = File.realpath(File.join(__dir__, '..'))
      mount('nullfs', lsu_dir, File.join('.', lsu_dir))
    end # chdir(mroot)
  rescue
    for path in $MOUNTS.reverse
      system("umount -f #{path}")
    end
    raise
  end
end
